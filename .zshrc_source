
[ ! -d ~/.config/nvim ] && mkdir -p ~/.config/nvim
alias git_submodule='git submodule update --init --recursive'
alias git_push='git branch --show-current | xargs -n 1 git push origin'
# alias showpath='echo "${(@s[:])PATH}" | xargs -n 1 | sort | uniq'
function showpath(){
  #FS = Field Separator (what is between the fields). FPAT = Field Pattern (what is in the fields)
  #NF = Number of Fields
  #RS = Record Split (could have just used this instead of setting FS and FPAT)
  #note that $0 = all fields. $1 is first field
  #awk returns records. each record contains fields
  #echo $PATH | awk  'BEGIN{FS=":";FPAT="[^\:]+"}{for (i=1;i<=NF;i++){print $i}}' \
  echo $PATH | awk 'BEGIN{RS=":"}{print $1}' | sort | uniq 
}
alias nvimedit='nvim -p ~/.zshrc ~/.config/nvim/.zshrc_source ~/.config/nvim/init.vim'
alias nvimdir='nvim -c "terminal" -c "CocCommand explorer"'
function nvimcommit(){

  if [ ! -z "$1" ]; then
    CURDIR=$PWD
    cd ~/.config/nvim
    git checkout master
    # cp ~/.zshrc ./.zshrc_copy
    # cp ~/.vimrc ./.vimrc_copy
    git add .
    git commit -m "$1"
    git push -u origin master
    cd "$CURDIR"
    unset CURDIR
  fi

}
function nvimstatus(){
  CURDIR=$PWD
  cd ~/.config/nvim
  git checkout master
  git status
  cd "$CURDIR"
  unset CURDIR
}
function nvimdiff(){
  CURDIR=$PWD
  cd ~/.config/nvim
  git checkout master
  git diff
  cd "$CURDIR"
  unset CURDIR
}
function lsdir(){
  ls -l $@ | awk '$1~/^d/{print $9}'
}

# prerequisites for fzf and vim
prereqs=(git fzf rg ag tree bat fd python3 ruby node npm nvim)
for i in $prereqs; do
  [ ! -x "$(command -v $i)" ] && echo "need to install $i"
done
unset prereqs

# if no ggrep, just use grep
[ ! -x "$(command -v ggrep)" ] && alias ggrep='grep'

#check if Vim Plug is installed
if [ ! -f "$HOME/.local/share/nvim/site/autoload/plug.vim" ]; then
  echo "install Vim Plug to neovim autoload directory"
fi

pfzf(){
  fzf --preview='less {}' \
  --bind shift-up:preview-up,shift-down:preview-down
}
# this should make fzf respect .gitignore files
# [ -f ~/.fzf.zsh ] && source ~/.fzf.zsh
if [ -z "$FZF_KEY_BINDINGS_FILE" ]; then
  echo "set \$FZF_KEY_BINDINGS_FILE \
    . Look in install dir to find .../key-bindings.zsh"
else
  source "$FZF_KEY_BINDINGS_FILE"
fi 
# if [ ! -d ~/.config/fzf-tab-completion ]; then
#   cd ~/.config
#   git clone https://github.com/lincheney/fzf-tab-completion
#   cd ~
# fi
if [ ! -d ~/.config/fzf-tab ]; then
  CUR="$PWD"
  cd ~/.config
  git clone https://github.com/Aloxaf/fzf-tab
  cd "$CUR"
  unset CUR
fi
# source ~/.config/fzf-tab-completion/zsh/fzf-zsh-completion.sh
# bindkey '^I' fzf_completion
source ~/.config/fzf-tab/fzf-tab.plugin.zsh
export FZF_DEFAULT_COMMAND='fd --type f'
export FZF_DEFAULT_OPTS="--height 90%"
export FZF_CTRL_T_COMMAND="$FZF_DEFAULT_COMMAND"
export FZF_CTRL_T_OPTS="--preview \
  'bat --color=always --theme=gruvbox-dark --line-range :100 {}' \
  --bind 'ctrl-p:toggle-preview,shift-up:preview-page-up,shift-down:preview-page-down' \
  --height=90%"
export FZF_CTRL_F_COMMAND="$FZF_DEFAULT_COMMAND"
export FZF_CTRL_F_OPTS="$FZF_DEFAULT_OPTS"
export FZF_ALT_C_COMMAND='fd --type d . --color=never --hidden'
export FZF_ALT_C_OPTS="--preview \
  'tree -C {} | head -50' \
  --height=90%"
#export FZF_CTRL_F_COMMAND="rg -i --no-heading"
bindkey -s "^f" "rgfzf^M" 
rgfzf() {
  #to do: if empty, don't call nvim
  FILE_SELECTED=$(rg -i --no-heading '' | fzf | ggrep -oP '[^\:]*(?=\:)' | head -1)
  if [ ! -z "$FILE_SELECTED" ]; then
    nvim $FILE_SELECTED
  fi
  unset FILE_SELECTED
}

# git aliases
alias git_cleanbranches='git checkout master && git branch \
  | grep -v "master" | xargs -n 1 git branch -d'
alias git_cleanbranchesD='git checkout master && git branch \
  | grep -v "master" | xargs -n 1 git branch -D'
alias docker_restart='docker ps -q | xargs docker restart'

listening() {
    if [ $# -eq 0 ]; then
        sudo lsof -iTCP -sTCP:LISTEN -n -P
    elif [ $# -eq 1 ]; then
        sudo lsof -iTCP -sTCP:LISTEN -n -P | grep -i --color $1
    else
        echo "Usage: listening [pattern]"
    fi
}


#format of terminal display showing just path
#https://scriptingosx.com/2019/07/moving-to-zsh-06-customizing-the-zsh-prompt/
#PS1='%m %~%# '#shows login and full directory
#PS1='%~%# '#shows full directory
#PS1='[%d] $ '#shows 2 folders back (not working)
PS1='%F{29}%K{238}%2~%F{default}%K{default} %# '
